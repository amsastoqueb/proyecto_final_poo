<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Catastro 3D – Arborizadora Alta</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden; }
    .legend { position:absolute; top:10px; left:10px; background:#fff9; padding:8px 12px; border-radius:6px; font-family:sans-serif; }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <div class="legend">
    <b>Catastro 3D – Arborizadora Alta</b><br>
    Altura = pisos × 3 m. Click para ver atributos.
  </div>
  <script>
    // 1) Configurar Cesium
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI4NTIyNDlhYy03OGZhLTRkNTctYjhhOC01NGFlYTRmZGFhNTQiLCJpZCI6MzMxMzcwLCJpYXQiOjE3NTUwNDI1OTF9.01glnnDUpehAFVaOO5v6Vfk5XnvjyEPt6wgYd7jP_9c';

    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      timeline: false, animation: false, geocoder: false,
      baseLayerPicker: true, shadows: false
    });

    // (Opcional) centra la cámara sobre Arborizadora Alta (aprox)
    viewer.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(-74.157, 4.565, 2500) // lon, lat, altura (m)
    });

    // 2) Cargar y extruir CONSTRUCCIONES
    Cesium.GeoJsonDataSource.load('arbalta_construcciones_4326.geojson', {
      clampToGround: false   // extrusión sobre el elipsoide/terreno
    }).then(ds => {
      viewer.dataSources.add(ds);

      const entities = ds.entities.values;
      for (let i = 0; i < entities.length; i++) {
        const e = entities[i];
        if (!e.polygon) continue;

        // Lee pisos (campo CONNPISOS)
        const pisosProp = e.properties && e.properties.CONNPISOS;
        const pisos = pisosProp ? Number(pisosProp.getValue()) : 1;  // fallback = 1

        const altura = Math.max(1, pisos) * 3; // metros (3m por piso)

        e.polygon.extrudedHeight = altura;
        e.polygon.height = 0; // base a nivel 0; si tienes z-base, cámbialo
        e.polygon.material = new Cesium.ColorMaterialProperty(Cesium.Color.fromRandom({alpha:0.85}));
        e.polygon.outline = true;
        e.polygon.outlineColor = Cesium.Color.BLACK;

        // Tooltip sencillo
        e.description = `
          <table>
            <tr><th style="text-align:left">Pisos</th><td>${pisos}</td></tr>
            <tr><th style="text-align:left">Altura (m)</th><td>${altura}</td></tr>
          </table>`;
      }

      // Ajuste de cámara a la capa
      viewer.flyTo(ds);
    }).catch(err => console.error('Error cargando construcciones:', err));

    // 3) (Opcional) Cargar PREDIOS como líneas para contexto
    Cesium.GeoJsonDataSource.load('arbalta_predios_4326.geojson', { clampToGround: true })
      .then(dsPred => {
        viewer.dataSources.add(dsPred);
        const ents = dsPred.entities.values;
        for (let i = 0; i < ents.length; i++) {
          const e = ents[i];
          if (e.polygon) {
            // Mostrar solo borde (sin extrusión)
            e.polygon.material = Cesium.Color.TRANSPARENT;
            e.polygon.outline = true;
            e.polygon.outlineColor = Cesium.Color.fromCssColorString('#00a1ff').withAlpha(0.9);
          }
          if (e.polyline) {
            e.polyline.material = Cesium.Color.fromCssColorString('#00a1ff').withAlpha(0.9);
            e.polyline.width = 1.5;
          }
        }
      })
      .catch(() => {/* predios opcional */});
  </script>
</body>
</html>